# SaleOrderAutomation_Python

**Last updated:** 2025-12-24 — email bot added
This repository contains a small automation pipeline that downloads sales and customer reports from a DMS, transforms the data into the expected Merlin format, writes an upload file, persists records into a local SQLite DB and posts records to a Merlin API endpoint.

This README was generated by inspecting the project code to summarize architecture, setup, and run steps.

## Highlights / Purpose

- Download Sales Order and Customer Master files from a DMS (Selenium-driven browser automation).
- Normalize and validate files, merge customer city into sales records and compute total price.
- Map records into a Merlin-compatible schema and write an Excel upload file.
- Persist records to `output/merlin.db` with `PENDING` status and then attempt API uploads to update statuses.
- Includes small dummy services for local testing: a dummy DMS (`dummy_dms/`) and a dummy Merlin API (`dummy_merlin_portal/`).
 - Added an email notifier bot (`scripts/email_notifier.py`) to send upload status notifications; configure SMTP in `project/config/config.py`.

## Prerequisites

- Python 3.8+
- Chrome browser (for Selenium download automation) and matching driver (Selenium Manager is used in code).
- Recommended packages: `pandas`, `openpyxl`, `selenium`, `requests`, `flask`.

Create a `requirements.txt` with at least:

```text
pandas
openpyxl
selenium
requests
flask
```

Install with:

```bash
python -m venv .venv
# PowerShell
.\.venv\Scripts\Activate.ps1
# or cmd
.\.venv\Scripts\activate.bat
pip install -r requirements.txt
```

## Configuration

The main configuration is in `project/config/config.py`. Key settings:

- `DMS_URL` / `LOGIN_URL` — URL for the DMS (default: `http://127.0.0.1:5000` for the dummy DMS).
- `USERNAME`, `PASSWORD` — DMS login credentials (currently hard-coded; move to env vars for production).
- `DOWNLOAD_DIR`, `INPUT_DIR`, `OUTPUT_DIR`, `LOG_DIR` — filesystem paths used by the pipeline.
- `MERLIN_API_URL` — endpoint to POST upload records (default points to dummy Merlin at `http://127.0.0.1:6000/upload`).
- Email SMTP settings are present but optional.

Important: do not keep real credentials in `config.py` for production. Prefer environment variables or a secrets manager.

## Directory layout (important files)

- `project/main.py` — main orchestration script (clears folders, downloads, renames, moves files, transforms, writes output, writes DB, triggers uploads).
- `project/scripts/dms_download.py` — Selenium logic to login to DMS and trigger downloads.
- `project/scripts/file_handler.py` — utilities to clear folders, wait for downloads, rename and move files.
- `project/scripts/transform.py` — read/validate Excel, merge customer data, compute `total_price`, map to Merlin format, write Excel, prepare payload.
- `project/scripts/db_writer.py` — write Merlin-format records to SQLite DB (`merlin_sales` table) with `PENDING` status.
- `project/scripts/merlin_uploader.py` — read `PENDING` rows and call `scripts/merlin_api.py` to upload single records; updates DB statuses.
- `dummy_dms/` — a Flask app that serves `sales_order.xlsx` and `customer_master.xlsx` for local testing.
- `dummy_merlin_portal/` — a Flask app that exposes `/upload` to receive and validate posted records.

## Data flow (high level — see `project/main.py` steps)

1. Clear `downloads`, `input`, and `output` folders and ensure they exist.
2. Use Selenium to login to DMS and click buttons that cause downloads.
3. Rename downloaded files to `sales_order.xlsx` and `customer_master.xlsx`.
4. Move files to `input/` and read them with `pandas`.
5. Validate required columns (customer mandatory columns enforced in code).
6. Merge `city` from customer master into sales using `retailer_id`.
7. Compute `total_price = QTY * UNIT_PRICE`.
8. Map columns to Merlin schema and clean datatypes.
9. Write Merlin Excel file to `output/` with timestamped filename.
10. Prepare JSON payload and (optionally) upload to Merlin API.
11. Persist records to `output/merlin.db` with `PENDING` status.
12. Process pending records and update statuses to `SUCCESS` or `FAILED`.

## How to run (local testing)

1. Create the dummy reports and start the dummy DMS:

```bash
# from repository root
python dummy_dms/create_reports.py
python dummy_dms/run_dms.py
```

2. Start the dummy Merlin API (optional, for end-to-end testing):

```bash
python dummy_merlin_portal/dummy_merlin_api.py
```

3. Run the automation pipeline:

```bash
python project/main.py
```

Outputs:
- Excel Merlin upload file is written to `output/` (filename `merlin_upload_YYYYMMDD_HHMMSS.xlsx`).
- SQLite DB `output/merlin.db` contains the `merlin_sales` table and upload statuses.

## Database

- The pipeline writes to `output/merlin.db` (SQLite). Table `merlin_sales` has these columns:
   `merlin_order_no, merlin_sku, merlin_qty, merlin_unit_price, merlin_total_price, merlin_retailer_id, merlin_city, status, error_message, created_at`.

## Notes, caveats & troubleshooting

- Selenium: the code uses Selenium with Chrome. Ensure Chrome is installed. Selenium Manager (webdriver) is used by `webdriver.Chrome()` to fetch the correct driver automatically; if issues occur, install a compatible ChromeDriver manually.
- File detection: `file_handler.wait_for_downloads()` waits for files in `DOWNLOAD_DIR` and ignores `.crdownload` temporary files.
- Column names: the pipeline expects uppercase column names in the sales file (`SO_NO`, `SKU_ID`, `QTY`, `UNIT_PRICE`, `retailer_id`) and the customer file (`retailer_id`, `retailer_name`, `city`).
- Config: update `project/config/config.py` to point to a real DMS and Merlin endpoints and to provide secure credentials.
- Logs: a basic logger is configured by `scripts/logger.py` (check and extend if needed).

## Development / Next steps

- Add `requirements.txt` and pin package versions for reproducibility.
- Move secrets to environment variables and use `os.getenv()` in `config.py`.
- Add tests for transform functions and DB writer.
- Add CI to run linting/tests and to build artifacts.
 - Email bot: `scripts/email_notifier.py` implemented to notify on upload `SUCCESS`/`FAILED` events — ensure SMTP settings in `project/config/config.py` are set if you enable email notifications.

## License

Add a `LICENSE` file to declare project license (e.g., MIT).

---

If you want, I can:

- Add a `requirements.txt` with the inferred packages and versions.
- Replace hard-coded credentials with a simple `.env` loader and example `.env` file.
- Add example commands to run each component in separate terminals.
